'use strict';

/** BUDDY BUILT **/

if ('undefined' === typeof self) var self = this;
if ('undefined' === typeof global) var global = self;
var $m = self.$m = self.$m || {};
if ('browser' != 'browser') {
  var $req = require;
  require = function buddyRequire (id) {
    if (!$m[id]) return $req(id);
    if ('function' == typeof $m[id]) $m[id]();
    return $m[id].exports;
  };
} else {
  if ('undefined' === typeof process) var process = {browser:true, env:{NODE_ENV:'development'}};
  self.require = self.require || function buddyRequire (id) {
    if ($m[id]) {
      if ('function' == typeof $m[id]) $m[id]();
      return $m[id].exports;
    }

    if ('development' == 'development') {
      console.warn('module ' + id + ' not found');
    }
  };
}

(function () {
/*== js/main.js ==*/
$m['js/main'] = { exports: {} };
var jsmain__scrollHelper = {
	easeInOut: function easeInOut(currentTime, start, change, duration) {
		currentTime /= duration / 2;
		if (currentTime < 1) {
			return change / 2 * currentTime * currentTime + start;
		}
		currentTime -= 1;
		return -change / 2 * (currentTime * (currentTime - 2) - 1) + start;
	},

	scrollTo: function scrollTo(to, duration) {
		var start = window.pageYOffset,
		    change = to - start,
		    increment = 20;

		if (duration === 0) {
			window.scrollTo(0, to);
			return;
		}

		var animateScroll = function animateScroll(elapsedTime) {
			elapsedTime += increment;
			var position = jsmain__scrollHelper.easeInOut(elapsedTime, start, change, duration);
			window.scrollTo(0, position);
			if (elapsedTime < duration) {
				requestAnimationFrame(function () {
					animateScroll(elapsedTime);
				});
			}
		};

		animateScroll(0);
	}
};

var jsmain___s = function jsmain___s(selector, context) {
	var d = context || document;
	return Array.apply(null, d.querySelectorAll(selector));
};

var jsmain___si = function jsmain___si(selector, context, returnNull) {
	var d = context || document;
	var tmp = d.querySelector(selector);
	return tmp ? tmp : returnNull ? null : document.createElement('div');
};

var jsmain___ael = function jsmain___ael(selector, ev, callback) {
	var elm = typeof selector === 'string' ? jsmain___si(selector) : selector;
	elm.addEventListener(ev, callback);
};

var jsmain___ajax = function jsmain___ajax(url, callback) {
	var request = new XMLHttpRequest();
	request.open('GET', url, true);

	request.onload = function () {
		if (request.status >= 200 && request.status < 400) {
			if (typeof callback === 'function') {
				callback(request);
			}
		} else {
			console.error('request error', request);
		}
	};

	request.onerror = function (err) {
		console.error('error', err);
	};

	request.send();
};

var jsmain__loadJSONP = function () {
	var unique = 0;
	return function (url, callback, context) {
		// INIT
		var name = "_jsonp_" + unique++;
		if (url.match(/\?/)) url += "&callback=" + name;else url += "?callback=" + name;

		// Create script
		var script = document.createElement('script');
		script.type = 'text/javascript';
		script.src = url;

		// Setup handler
		window[name] = function (data) {
			callback.call(context || window, data);
			document.getElementsByTagName('head')[0].removeChild(script);
			script = null;
			delete window[name];
		};

		// Load JSON
		document.getElementsByTagName('head')[0].appendChild(script);
	};
}();

(function () {

	var html = jsmain___si('html'),
	    scrollTop = window.pageYOffset,
	    oldScrollTop = 0,
	    sections = jsmain___s('[data-link-url]'),
	    sectionTops = [],
	    phoneMenu = window.innerWidth < 635,
	    menuHeight = phoneMenu ? 0 : 70,
	    sizes = {
		showMenu: 635
	},
	    window_width = window.innerWidth,
	    logo = jsmain___si('.logo'),
	    logoTop = logo.getBoundingClientRect().top + scrollTop;

	function render() {
		if (scrollTop !== oldScrollTop) {
			if (sectionTops.length === 0) {
				sections.forEach(function (s) {
					sectionTops.push(s.getBoundingClientRect().top + scrollTop - menuHeight);
				});
			}
			if (scrollTop > logoTop + 20) {
				html.classList.add('toggle--logo-in-menu');
			} else {
				html.classList.remove('toggle--logo-in-menu');
			}

			for (var i = sectionTops.length; i--;) {
				if (scrollTop > sectionTops[i]) {
					var li = jsmain___s('nav li')[i];
					if (!li.classList.contains('active')) {
						jsmain___si('nav li.active').classList.remove('active');
						li.classList.add('active');
						var url = jsmain___si('a', li).href;
						url = url.substr(url.indexOf('#'));
						location.hash = url;
					}
					break;
				}
			}
			oldScrollTop = scrollTop;
		}

		requestAnimationFrame(render);
	}

	if (window_width >= sizes.showMenu) {
		render();
	}

	jsmain___ael(document, 'scroll', function (e) {
		scrollTop = window.pageYOffset;
	});

	jsmain___ael('.menu_toggle', 'click', function () {
		html.classList.toggle('show--menu');
	});

	jsmain___ael('nav', 'click', function (e) {
		var li = e.target.closest('li');
		if (li) {
			var url = jsmain___si('a', li).href;
			url = url.substr(url.indexOf('#') + 1);
			var section = jsmain___si('[data-link-url="' + url + '"]');
			jsmain__scrollHelper.scrollTo(section.getBoundingClientRect().top + scrollTop + 1, 300);
			html.classList.remove('show--menu');
		}
	});

	jsmain___ael('.logo', 'click', function (e) {
		jsmain__scrollHelper.scrollTo(0, 300);
	});

	if (location.hash.length > 2) {
		jsmain___si('nav a[href*="' + location.hash + '"]').click();
	}

	jsmain___ael('.block--conduct .toggle-extra', 'click', function (e) {
		e.preventDefault();
		this.closest('.block').classList.toggle('open');
	});

	jsmain___ajax('https://api.trondheimdc.no/events/tdc2017/sessions', loadSpeakers);
	function loadSpeakers(data) {
		var speakers = JSON.parse(data.responseText);
		var fallbackImg = '//placehold.it/360x240/117fe8/fff';
		var listHtml = '';
		speakers.forEach(function (sessh) {
			var img = sessh.foredragsholdere[0].bildeUri || fallbackImg;
			var name = sessh.foredragsholdere[0].navn;
			var title = sessh.tittel;
			listHtml += '<li>\n\t\t\t\t\t\t\t<img src="' + img + '">\n\t\t\t\t\t\t\t<h5>' + name + '</h5>\n\t\t\t\t\t\t\t<p>' + title + '</p>\n\t\t\t\t\t\t</li>';
		});

		jsmain___si('.block--speakers ul').innerHTML = listHtml;
	}

	jsmain__loadJSONP('https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=00622ccfe6e4d518ca49b0b5105abb54&per_page=20&user_id=trondheimdc&tags=Approved&page=2&extras=o_dims&format=json');

	function Mouse(element, callback) {
		this.callback = callback;
		this.element = element;
		this.handler = this.handler.bind(this);
		this.L = this.M = this.R = this.X = this.Y = 0;
		element.addEventListener('contextmenu', this.handler);
		element.addEventListener('mousedown', this.handler);
		window.addEventListener('mouseup', this.handler);
		window.addEventListener('mousemove', this.handler);
	}

	Mouse.prototype.map = { 0: 'L', 1: 'M', 2: 'R' };

	Mouse.prototype.handler = function (e) {
		var b = this.element.getBoundingClientRect();
		this.X = e.clientX - b.left;
		this.Y = e.clientY - b.top;
		switch (e.type) {
			case 'contextmenu':
				e.preventDefault();break;
			case 'mousedown':
				this[this.map[e.button]] = 1;break;
			case 'mouseup':
				this[this.map[e.button]] = 0;break;
		}
		this.callback && this.callback(e);
	};

	function Particle(field, x, y) {
		this.field = field;
		this.l = vec4.get(x, y);
		this.p = vec4.get(x, y);
		this.v = vec4.get();
	}

	Particle.prototype.reset = function (x, y) {
		if (x == null || y == null) if (Math.random() < 0.5) {
			x = this.field.width * Math.random();
			y = this.field.height * (Math.random() + 0.5 | 0);
		} else {
			x = this.field.width * (Math.random() + 0.5 | 0);
			y = this.field.height * Math.random();
		}

		vec4.set(this.l, x, y);
		vec4.set(this.p, x, y);
		vec4.set(this.v);
	};

	Particle.prototype.outOfBounds = function () {
		return this.p[0] < 0 || this.p[0] > this.field.width || this.p[1] < 0 || this.p[1] > this.field.height;
	};

	Particle.prototype.update = function () {
		if (this.outOfBounds()) return;

		var x = 0.00550 * this.p[0];
		var y = 0.00550 * this.p[1];
		var z = 0.0001 * this.field.now;
		var r = Math.random() * 0.5;
		var t = Math.random() * Math.PI * 2;

		vec4.set(vec4.buffer, r * Math.sin(t) + this.field.simplex.noise3D(x, y, +z), r * Math.cos(t) + this.field.simplex.noise3D(x, y, -z));
		vec4.add(this.v, vec4.buffer, this.v);

		if (this.field.mouse.L) {
			vec4.set(vec4.buffer, this.field.mouse.X, this.field.mouse.Y);
			vec4.sub(vec4.buffer, this.p, vec4.buffer);
			vec4.mul(vec4.buffer, 0.0010, vec4.buffer);
			vec4.add(this.v, vec4.buffer, this.v);
		}

		vec4.mul(this.v * 0.5, 0.9500, this.v * 0.5);
		vec4.set(this.l, this.p, this.l);
		vec4.add(this.p, this.v, this.p);

		return true;
	};

	function Field(container) {
		this.loop = this.loop.bind(this);
		this.canvas = util.tag('canvas', null, container);
		this.info = util.tag('code', null, container);
		this.context = this.canvas.getContext('2d');
		this.mouse = new Mouse(this.canvas);
		this.simplex = new SimplexNoise();
		this.particles = [];
		this.loop();
	}

	Field.prototype.spawn = function () {
		for (var i = 1e4 - this.particles.length; i--;) {
			this.particles.push(new Particle(this));
		}
	};

	Field.prototype.resize = function () {
		var w = this.canvas.clientWidth;
		var h = this.canvas.clientHeight;
		if (this.canvas.width !== w || this.canvas.height !== h) {
			this.width = this.canvas.width = w;
			this.height = this.canvas.height = h;
			this.clear();
		}
	};

	Field.prototype.clear = function () {
		this.context.fillStyle = util.color.rgba(1, 1, 1);
		this.context.fillRect(0, 0, this.width, this.height);
	};

	Field.prototype.render = function () {
		this.context.beginPath();

		for (var p, i = 0; p = this.particles[i++];) {
			if (p.update()) {
				this.context.moveTo(p.l[0], p.l[1]);
				this.context.lineTo(p.p[0], p.p[1]);
			} else p.reset();
		} // this.particles.splice(--i, 1);

		this.context.globalCompositeOperation = 'lighter';
		this.context.strokeStyle = util.color.rgba(0.61, 0.76, 0.10, 0.25);
		this.context.stroke();

		this.context.globalCompositeOperation = 'source-over';
		this.context.fillStyle = util.color.rgba(0, 0, 0, 0.05);
		this.context.fillRect(0, 0, this.width, this.height);
	};

	Field.prototype.update = function () {
		this.info.textContent = util.fps(true);
		this.now = Date.now();
		this.resize();
		this.spawn();
		this.render();
	};

	Field.prototype.loop = function () {
		requestAnimationFrame(this.loop);
		this.update();
	};

	window.addEventListener('load', function () {
		new Field(document.body);
	}, false);

	html.classList.remove('no-js');
	if ('ontouchstart' in document) {
		html.classList.add('touch');
	} else {
		html.classList.add('no-touch');
	}
})();
/*≠≠ js/main.js ≠≠*/
})()